# Authentication & Authorization

> **Tools:** Rails Native Auth (Rails 8+), Pundit
> **Philosophy:** Minimalist authentication, Explicit authorization.

## 1. Authentication (Rails Native)
Avoid Devise for new projects. Use the built-in Rails 8 authentication generator.

### Setup
```bash
bin/rails generate authentication
```
This generates `User`, `Session`, `PasswordsController`, etc.

### Hardening (`app/models/user.rb`)
Rails uses `has_secure_password` under the hood.

```ruby
class User < ApplicationRecord
  has_secure_password

  validates :password, length: { minimum: 12 }, allow_nil: true
  
  # Sessions
  has_many :sessions, dependent: :destroy

  normalizes :email_address, with: ->(e) { e.strip.downcase }
end
```

### Session Management
Use `Current` attributes (generated by Rails) for access.

```ruby
# ApplicationController
before_action :authenticate
def authenticate
  if session_record = Session.find_by_id(cookies.signed[:session_id])
    Current.session = session_record
  else
    redirect_to new_session_path
  end
end
```

## 2. Authorization (Pundit)
Explicit policies for every resource.

### Policy Structure
```ruby
class ArticlePolicy < ApplicationPolicy
  def update?
    user.admin? || record.user == user
  end

  class Scope < Scope
    def resolve
      user.admin? ? scope.all : scope.where(user: user)
    end
  end
end
```

### Controller Usage
**Always** use `authorize` in every action and `policy_scope` for lists.

```ruby
def index
  @articles = policy_scope(Article)
end

def update
  authorize @article
  if @article.update(params) ...
end
```

### Testing Policies
```ruby
permissions :update? do
  it "grants access to admin" do
    expect(described_class).to permit(admin, article)
  end

  it "denies access to stranger" do
    expect(described_class).not_to permit(stranger, article)
  end
end
```